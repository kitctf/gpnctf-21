var u=Object.defineProperty;var f=(t,e,i)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var h=(t,e,i)=>(f(t,typeof e!="symbol"?e+"":e,i),i);import{m as l,C as o,t as g,a as m,M as p}from"./index.01dfa420.js";import{e as w}from"./animated.e1c5aff2.js";import{g as y,e as _}from"./index.445cba59.js";import"./echarts.115d5322.js";window.Alpine=l;window.CTFd=o;l.store("firstBlood",{solve:null,challenge_name:""});class C{constructor(e,i){h(this,"queue");this.queue=[],this.isConsuming=!1,this.modal=new p(e),this.getChallengeName=i}notify(){this.isConsuming||this.consumeNext()}async consumeNext(){if(this.isConsuming=!0,this.queue.length>0){try{await this.consume(this.queue.shift())}catch(e){console.log(e)}this.consumeNext()}else this.isConsuming=!1}async consume(e){l.store("firstBlood").solve=e,l.store("firstBlood").challenge_name=this.getChallengeName(e.challenge_id),this.modal.show(),await new Promise(i=>setTimeout(i,6e4)),this.modal.hide()}}l.data("Scoreboard",()=>({presentationOn:!1,events:null,handler:null,challenges:null,standings:[],accounts:new Set,latest:new Date(Date.UTC(2024,1,1,0,0,0,0)).toISOString(),dataHandler:null,detailData:null,detailAvailable:!0,firstBloodConsumer:null,async init(){this.events=w,this.firstBloodConsumer=new C(this.$refs.firstBloodWindow,t=>this.challenges.find(e=>e.id==t)?this.challenges.find(e=>e.id==t).name:""),window.addEventListener("sse:message",t=>{if(t.detail.type==="challenge"){if(this.challenges!=null)if(t.detail.action=="remove")this.challenges=this.challenges.filter(e=>e.id!=t.detail.id);else if(t.detail.action=="add")this.challenges.push(t.detail),this.challenges.sort((e,i)=>e.category>i.category||e.category==i.category&&e.name>i.name?1:e.category==i.category&&e.name==i.name?0:-1);else{const e=this.challenges.findIndex(i=>i.id==t.detail.id);this.challenges[e]=t.detail}}else if(t.detail.type==="solve"){for(const e of t.detail.batch){if(e.solve_count>1)break;this.firstBloodConsumer.queue.push(e)}this.challenges==null?setTimeout(()=>{this.firstBloodConsumer.notify()},5e3):this.firstBloodConsumer.notify()}}),o.fetch("/sync/challenges").then(t=>t.json()).then(t=>{this.challenges=t}).catch(console.error),await this.updateGraph(),g()},async updateGraph(){if(this.detailData=await o.pages.scoreboard.getScoreboardDetail(10),Object.keys(this.detailData).length===0){this.detailAvailable=!1;return}let t=y(o.config.userMode,this.detailData);_(this.$refs.scoregraph,t)},registerTooltip(t){new m(t,{offset:[0,8]})},togglePresentationMode(){this.presentationOn?(window.removeEventListener("sse:control",this.handler),this.events.tryDisconnectToFullStream(),this.presentationOn=!1,this.deactivatePresentation()):(this.handler=t=>{t.detail.isMaster?(this.events.tryConnectToFullStream(),this.activatePresentation(),this.presentationOn=!0):(this.presentationOn=!1,this.deactivatePresentation(),window.removeEventListener("sse:control",this.handler))},window.addEventListener("sse:control",this.handler),this.events.tryGetMaster()&&(this.events.tryConnectToFullStream(),this.activatePresentation(),this.presentationOn=!0))},activatePresentation(){this.dataHandler=t=>{if(t.detail.type==="challenge"&&(t.detail.action=="update"||t.detail.action=="remove")){const e=new Date(Date.UTC(2024,1,1,0,0,0,0)).toISOString();this.latest!=e&&(this.latest=e,this.accounts=new Set,o.fetch("/sync/standings").then(i=>i.json()).then(i=>{this.standings=i.standings,this.latest=i.latest,this.standings.map(n=>{this.accounts.add(n.account_id)})}).catch(console.error))}if(t.detail.type==="solve"&&t.detail.latest>this.latest){let e=!1;const i=new Set;for(let s=0;s<this.standings.length&&s<10;s++)i.add(this.standings[s].account_id);const n=JSON.parse(JSON.stringify(this.standings)),d={};for(const s of t.detail.batch)d[s.account_id]=s,this.accounts.has(s.account_id)||(n.push({account_id:s.account_id,name:s.account_name,score:0,date:"",url:"/teams/"+s.account_id,solves:[],bloods:[]}),this.accounts.add(s.account_id));const r=t.detail.standings;for(const s of n){if(s.account_id in r&&(s.score=r[s.account_id]),s.account_id in d){const a=d[s.account_id];s.solves.push(a.challenge_id),s.date=a.date,a.solve_count===1&&s.bloods.push(a.challenge_id)}i.has(s.account_id)&&(e=!0)}n.sort((s,a)=>s.score<a.score||s.score==a.score&&(s.date>a.date||s.date==a.date&&s.account_id>a.account_id)?1:s.score==a.score&&s.date==a.date&&s.id==a.id?0:-1);const c=new Set;for(let s=0;s<n.length&&s<10;s++)c.add(n[s].account_id);this.standings=n,(e||!(i.size===c.size&&[...i].every(s=>c.has(s))))&&this.updateGraph(),t.detail.latest>this.latest&&(this.latest=t.detail.latest)}},window.addEventListener("sse:message",this.dataHandler),o.fetch("/sync/standings").then(t=>t.json()).then(t=>{this.standings=t.standings,this.latest=t.latest,this.standings.map(e=>{this.accounts.add(e.account_id)})}).catch(console.error)},deactivatePresentation(){window.removeEventListener("sse:message",this.dataHandler),this.standings=[],this.accounts=new Set,this.latest=new Date(Date.UTC(2024,1,1,0,0,0,0)).toISOString(),this.dataHandler=null}}));l.start();
