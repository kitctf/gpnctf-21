import{m as l,C as r,a as d}from"./index.01dfa420.js";class h{constructor(){this.id=Date.now()*1e3+Math.random()*1e3,this.isMaster=!1,this._seen={},this._control=new BroadcastChannel("wc"),this._messages=new BroadcastChannel("wc:events"),this._control.addEventListener("message",t=>{this.handleControl(t)}),this._messages.addEventListener("message",t=>{this.handleBroadcast(t)}),window.addEventListener("unload",t=>{this.handleUnload(t)}),setTimeout(this.check.bind(this),500),this.start()}destroy(){clearInterval(this._pingInterval),clearInterval(this._checkInterval),this.end(),window.removeEventListener("unload",this.handleUnload)}start(){this.broadcastControl("hello")}end(){this.broadcastControl("bye")}sendPing(){this.broadcastControl("ping")}handleUnload(t){this.destroy()}handleControl(t){t.data.id!==this.id&&this[t.data.type](t.data)}handleBroadcast(t){try{t.data.id!==this.id&&this.dispatchEvent(t.data.type,t.data.data)}catch(a){console.error(a)}}hello(t){if(this.ping(t),t.id<this.id){this.check();return}this.sendPing()}ping(t){this._seen[t.id]=!0}bye(t){delete this._seen[t.id],this.check()}check(){let t=!0;const a=this.id;for(const n in this._seen)n<a&&(t=!1);this.isMaster!==t&&(this.isMaster=t,this.masterDidChange())}tryGetMaster(){if(this.isMaster)return!0;this.end();const t=Math.min(Object.keys(this._seen));return this.id=(Math.floor(t/1e3)-1)*1e3+this.id%1e3,this.start(),setTimeout(this.check.bind(this),500),!1}masterDidChange(){}dispatchEvent(t,a){const n=new CustomEvent(t,{detail:a});window.dispatchEvent(n)}broadcastControl(t){const a={id:this.id,type:t};this._control.postMessage(a)}broadcastMessage(t,a){const n={id:this.id,type:t,data:a};try{this._messages.postMessage(n),this.dispatchEvent(t,a)}catch(i){console.error(i)}}}const s={init:e=>{s._sseHost=e,window.addEventListener("beforeunload",t=>{s.disconnect()})},controller:new h,_sseHost:"",source:null,connect:()=>{s.source=new EventSource(s._sseHost+"/stream"),s.source.addEventListener("message",e=>{const t=JSON.parse(e.data);s.controller.broadcastMessage("sse:message",t)},!1)},disconnect:()=>{s.source&&s.source.close()},tryGetMaster:()=>s.controller.tryGetMaster(),tryConnectToFullStream:()=>s.controller.isMaster?(s.source.close(),s.source=new EventSource(s._sseHost+"/stream?channel=full"),s.source.addEventListener("message",e=>{const t=JSON.parse(e.data);s.controller.broadcastMessage("sse:message",t)},!1),!0):!1,tryDisconnectToFullStream:()=>s.controller.isMaster?(s.source.close(),s.connect(),!0):!1};s.controller.masterDidChange=function(){this.isMaster?s.connect():s.disconnect();const e=new CustomEvent("sse:control",{detail:{isMaster:this.isMaster}});window.dispatchEvent(e)};function o(e){const t=document.createElement("p");return t.appendChild(document.createTextNode(e)),t.innerHTML}l.data("Animation",()=>({challenges:{},submissions:{},submission_counter:0,tooltips:{},async init(){s.init(r.config.sseHost),r.fetch("/sync/challenges").then(e=>e.json()).then(e=>{for(const t of e)this.challenges[t.id]=t}).catch(console.error),window.addEventListener("sse:message",e=>{switch(e.detail.type){case"challenge":e.detail.action=="remove"?delete this.challenges[e.detail.id]:this.challenges[e.detail.id]=e.detail;break;case"solve":if(document.visibilityState=="visible"){const t={id:this.submission_counter++,data:e.detail};this.submissions[t.id]=t}break}})},register(e){this.tooltips[e.id]=new d(e,{offset:[0,8]})},unregister(e){this.tooltips[e.id].dispose(),delete this.tooltips[e.id],delete this.submissions[e.id]},getTooltip(e){if(e.data.batch.length==1){const a=this.challenges[e.data.batch[0].challenge_id].name,n=e.data.batch[0].account_name,i=e.data.batch[0].solve_count;return`<b>${o(a)} (${i})</b> - ${o(n)}`}let t="<ul>";for(let a=0;a<e.data.batch.length&&a<5;a++){const n=e.data.batch[a],i=this.challenges[n.challenge_id].name,c=n.account_name;t+=`<li><b>${o(i)} (${n.solve_count})</b> - ${o(c)}</li>`}return e.data.batch.length>5&&(t+="<li><b>...</b></li>"),t+="</ul>",t}}));export{s as e};
